{"ast":null,"code":"import isSubset from '../../utils/isSubset';\nimport logger from \"../../utils/logger\";\nimport selectionLevel from '../../api-utils/selectionLevel';\nimport success from '../../api-utils/success';\nimport error from '../../api-utils/error';\nimport showUserErrors from '../../api-utils/showUserErrors';\nexport default function deleteIt() {\n  var _this = this;\n\n  return new Promise(function (resolve, reject) {\n    // delete database\n    _this.deleteDatabase = function () {\n      var dbName = _this.dbName;\n      indexedDB.deleteDatabase(dbName);\n      resolve(success.call(_this, \"Database \\\"\".concat(dbName, \"\\\" deleted.\")));\n    }; // delete collection\n\n\n    _this.deleteCollection = function () {\n      var dbName = _this.dbName;\n      var collectionName = _this.collectionName; // we can only delete one collection at a time, which is why we need a queue\n\n      _this.addToDeleteCollectionQueue = function (collectionName) {\n        _this.deleteCollectionQueue.queue.push(collectionName);\n\n        _this.runDeleteCollectionQueue();\n      };\n\n      _this.runDeleteCollectionQueue = function () {\n        if (_this.deleteCollectionQueue.running == false) {\n          _this.deleteCollectionQueue.running = true;\n\n          _this.deleteNextCollectionFromQueue();\n        }\n      };\n\n      _this.deleteNextCollectionFromQueue = function () {\n        if (_this.deleteCollectionQueue.queue.length) {\n          var collectionToDelete = _this.deleteCollectionQueue.queue[0];\n\n          _this.deleteCollectionQueue.queue.shift();\n\n          _this.lf[collectionToDelete].dropInstance({\n            name: dbName,\n            storeName: collectionToDelete\n          }).then(function () {\n            _this.deleteNextCollectionFromQueue();\n\n            resolve(success.call(_this, \"Collection \\\"\".concat(collectionToDelete, \"\\\" deleted.\")));\n          }).catch(function (error) {\n            reject(error.call(_this, \"Collection \\\"\".concat(collectionToDelete, \"\\\" could not be deleted.\")));\n          });\n        } else {\n          _this.deleteCollectionQueue.running = false;\n        }\n      };\n\n      _this.addToDeleteCollectionQueue(collectionName);\n    }; // delete document\n\n\n    _this.deleteDocument = function () {\n      var collectionName = _this.collectionName;\n      var docSelectionCriteria = _this.docSelectionCriteria; // delete document by criteria\n\n      _this.deleteDocumentByCriteria = function () {\n        var keysForDeletion = [];\n\n        _this.lf[collectionName].iterate(function (value, key) {\n          if (isSubset(value, docSelectionCriteria)) {\n            keysForDeletion.push(key);\n          }\n        }).then(function () {\n          if (!keysForDeletion.length) {\n            reject(error.call(_this, \"No Documents found in \\\"\".concat(collectionName, \"\\\" Collection with criteria \").concat(JSON.stringify(docSelectionCriteria), \". No documents deleted.\")));\n          }\n\n          if (keysForDeletion.length > 1) {\n            logger.warn.call(_this, \"Multiple documents (\".concat(keysForDeletion.length, \") with \").concat(JSON.stringify(docSelectionCriteria), \" found.\"));\n          }\n        }).then(function () {\n          keysForDeletion.forEach(function (key, index) {\n            _this.lf[collectionName].removeItem(key).then(function () {\n              if (index === keysForDeletion.length - 1) {\n                resolve(success.call(_this, \"\".concat(keysForDeletion.length, \" Document\").concat(keysForDeletion.length > 1 ? 's' : '', \" with \").concat(JSON.stringify(docSelectionCriteria), \" deleted.\")));\n              }\n            }).catch(function (err) {\n              reject(error.call(_this, \"Could not delete \".concat(keysForDeletion.length, \" Documents in \").concat(collectionName, \" Collection.\")));\n            });\n          });\n        });\n      }; // delete document by key\n\n\n      _this.deleteDocumentByKey = function () {\n        _this.lf[collectionName].getItem(docSelectionCriteria).then(function (value) {\n          if (value) {\n            _this.lf[collectionName].removeItem(docSelectionCriteria).then(function () {\n              resolve(success.call(_this, \"Document with key \".concat(JSON.stringify(docSelectionCriteria), \" deleted.\")));\n            }).catch(function (err) {\n              reject(error.call(this, \"No Document found in \\\"\".concat(collectionName, \"\\\" Collection with key \").concat(JSON.stringify(docSelectionCriteria), \". No document was deleted.\")));\n            });\n          } else {\n            reject(error.call(_this, \"No Document found in \\\"\".concat(collectionName, \"\\\" Collection with key \").concat(JSON.stringify(docSelectionCriteria), \". No document was deleted.\")));\n          }\n        });\n      };\n\n      if (typeof docSelectionCriteria == 'object') {\n        return _this.deleteDocumentByCriteria();\n      } else {\n        return _this.deleteDocumentByKey();\n      }\n    };\n\n    if (!_this.userErrors.length) {\n      var currentSelectionLevel = selectionLevel.call(_this);\n\n      if (currentSelectionLevel == 'db') {\n        return _this.deleteDatabase();\n      } else if (currentSelectionLevel == 'collection') {\n        return _this.deleteCollection();\n      } else if (currentSelectionLevel == 'doc') {\n        return _this.deleteDocument();\n      }\n    } else {\n      showUserErrors.call(_this);\n    }\n  });\n}","map":{"version":3,"sources":["/Users/constantine/Dev/FrontEnd/progress/node_modules/localbase/localbase/api/actions/delete.js"],"names":["isSubset","logger","selectionLevel","success","error","showUserErrors","deleteIt","Promise","resolve","reject","deleteDatabase","dbName","indexedDB","call","deleteCollection","collectionName","addToDeleteCollectionQueue","deleteCollectionQueue","queue","push","runDeleteCollectionQueue","running","deleteNextCollectionFromQueue","length","collectionToDelete","shift","lf","dropInstance","name","storeName","then","catch","deleteDocument","docSelectionCriteria","deleteDocumentByCriteria","keysForDeletion","iterate","value","key","JSON","stringify","warn","forEach","index","removeItem","err","deleteDocumentByKey","getItem","userErrors","currentSelectionLevel"],"mappings":"AAAA,OAAOA,QAAP,MAAqB,sBAArB;AACA,OAAOC,MAAP,MAAmB,oBAAnB;AACA,OAAOC,cAAP,MAA2B,gCAA3B;AACA,OAAOC,OAAP,MAAoB,yBAApB;AACA,OAAOC,KAAP,MAAkB,uBAAlB;AACA,OAAOC,cAAP,MAA2B,gCAA3B;AAEA,eAAe,SAASC,QAAT,GAAoB;AAAA;;AAEjC,SAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAEtC;AACA,IAAA,KAAI,CAACC,cAAL,GAAsB,YAAM;AAC1B,UAAIC,MAAM,GAAG,KAAI,CAACA,MAAlB;AAEAC,MAAAA,SAAS,CAACF,cAAV,CAAyBC,MAAzB;AACAH,MAAAA,OAAO,CACLL,OAAO,CAACU,IAAR,CACE,KADF,uBAEgBF,MAFhB,iBADK,CAAP;AAMD,KAVD,CAHsC,CAetC;;;AACA,IAAA,KAAI,CAACG,gBAAL,GAAwB,YAAM;AAC5B,UAAIH,MAAM,GAAG,KAAI,CAACA,MAAlB;AACA,UAAII,cAAc,GAAG,KAAI,CAACA,cAA1B,CAF4B,CAI5B;;AAEA,MAAA,KAAI,CAACC,0BAAL,GAAkC,UAACD,cAAD,EAAoB;AACpD,QAAA,KAAI,CAACE,qBAAL,CAA2BC,KAA3B,CAAiCC,IAAjC,CAAsCJ,cAAtC;;AACA,QAAA,KAAI,CAACK,wBAAL;AACD,OAHD;;AAKA,MAAA,KAAI,CAACA,wBAAL,GAAgC,YAAM;AACpC,YAAI,KAAI,CAACH,qBAAL,CAA2BI,OAA3B,IAAsC,KAA1C,EAAiD;AAC/C,UAAA,KAAI,CAACJ,qBAAL,CAA2BI,OAA3B,GAAqC,IAArC;;AACA,UAAA,KAAI,CAACC,6BAAL;AACD;AACF,OALD;;AAOA,MAAA,KAAI,CAACA,6BAAL,GAAqC,YAAM;AACzC,YAAI,KAAI,CAACL,qBAAL,CAA2BC,KAA3B,CAAiCK,MAArC,EAA6C;AAC3C,cAAIC,kBAAkB,GAAG,KAAI,CAACP,qBAAL,CAA2BC,KAA3B,CAAiC,CAAjC,CAAzB;;AACA,UAAA,KAAI,CAACD,qBAAL,CAA2BC,KAA3B,CAAiCO,KAAjC;;AAEA,UAAA,KAAI,CAACC,EAAL,CAAQF,kBAAR,EAA4BG,YAA5B,CAAyC;AACvCC,YAAAA,IAAI,EAAUjB,MADyB;AAEvCkB,YAAAA,SAAS,EAAKL;AAFyB,WAAzC,EAGGM,IAHH,CAGQ,YAAM;AACZ,YAAA,KAAI,CAACR,6BAAL;;AACAd,YAAAA,OAAO,CACLL,OAAO,CAACU,IAAR,CACE,KADF,yBAEkBW,kBAFlB,iBADK,CAAP;AAMD,WAXD,EAWGO,KAXH,CAWS,UAAA3B,KAAK,EAAI;AAChBK,YAAAA,MAAM,CACJL,KAAK,CAACS,IAAN,CACE,KADF,yBAEkBW,kBAFlB,8BADI,CAAN;AAMD,WAlBD;AAmBD,SAvBD,MAwBK;AACH,UAAA,KAAI,CAACP,qBAAL,CAA2BI,OAA3B,GAAqC,KAArC;AACD;AACF,OA5BD;;AA8BA,MAAA,KAAI,CAACL,0BAAL,CAAgCD,cAAhC;AACD,KAjDD,CAhBsC,CAmEtC;;;AACA,IAAA,KAAI,CAACiB,cAAL,GAAsB,YAAM;AAE1B,UAAIjB,cAAc,GAAG,KAAI,CAACA,cAA1B;AACA,UAAIkB,oBAAoB,GAAG,KAAI,CAACA,oBAAhC,CAH0B,CAK1B;;AACA,MAAA,KAAI,CAACC,wBAAL,GAAgC,YAAM;AACpC,YAAIC,eAAe,GAAG,EAAtB;;AACA,QAAA,KAAI,CAACT,EAAL,CAAQX,cAAR,EAAwBqB,OAAxB,CAAgC,UAACC,KAAD,EAAQC,GAAR,EAAgB;AAC9C,cAAItC,QAAQ,CAACqC,KAAD,EAAQJ,oBAAR,CAAZ,EAA2C;AACzCE,YAAAA,eAAe,CAAChB,IAAhB,CAAqBmB,GAArB;AACD;AACF,SAJD,EAIGR,IAJH,CAIQ,YAAM;AACZ,cAAI,CAACK,eAAe,CAACZ,MAArB,EAA6B;AAC3Bd,YAAAA,MAAM,CACJL,KAAK,CAACS,IAAN,CACE,KADF,oCAE6BE,cAF7B,yCAE2EwB,IAAI,CAACC,SAAL,CAAeP,oBAAf,CAF3E,6BADI,CAAN;AAMD;;AACD,cAAIE,eAAe,CAACZ,MAAhB,GAAyB,CAA7B,EAAgC;AAC9BtB,YAAAA,MAAM,CAACwC,IAAP,CAAY5B,IAAZ,CAAiB,KAAjB,gCAA+CsB,eAAe,CAACZ,MAA/D,oBAAiFgB,IAAI,CAACC,SAAL,CAAeP,oBAAf,CAAjF;AACD;AACF,SAhBD,EAgBGH,IAhBH,CAgBQ,YAAM;AACZK,UAAAA,eAAe,CAACO,OAAhB,CAAwB,UAACJ,GAAD,EAAMK,KAAN,EAAgB;AACtC,YAAA,KAAI,CAACjB,EAAL,CAAQX,cAAR,EAAwB6B,UAAxB,CAAmCN,GAAnC,EAAwCR,IAAxC,CAA6C,YAAM;AACjD,kBAAIa,KAAK,KAAMR,eAAe,CAACZ,MAAhB,GAAyB,CAAxC,EAA4C;AAC1Cf,gBAAAA,OAAO,CACLL,OAAO,CAACU,IAAR,CACE,KADF,YAEMsB,eAAe,CAACZ,MAFtB,sBAE0CY,eAAe,CAACZ,MAAhB,GAAyB,CAAzB,GAA6B,GAA7B,GAAmC,EAF7E,mBAE0FgB,IAAI,CAACC,SAAL,CAAeP,oBAAf,CAF1F,eADK,CAAP;AAMD;AACF,aATD,EASGF,KATH,CASS,UAAAc,GAAG,EAAI;AACdpC,cAAAA,MAAM,CACJL,KAAK,CAACS,IAAN,CACE,KADF,6BAEuBsB,eAAe,CAACZ,MAFvC,2BAEgER,cAFhE,kBADI,CAAN;AAMD,aAhBD;AAiBD,WAlBD;AAmBD,SApCD;AAqCD,OAvCD,CAN0B,CA+C1B;;;AACA,MAAA,KAAI,CAAC+B,mBAAL,GAA2B,YAAM;AAC/B,QAAA,KAAI,CAACpB,EAAL,CAAQX,cAAR,EAAwBgC,OAAxB,CAAgCd,oBAAhC,EAAsDH,IAAtD,CAA2D,UAAAO,KAAK,EAAI;AAClE,cAAIA,KAAJ,EAAW;AACT,YAAA,KAAI,CAACX,EAAL,CAAQX,cAAR,EAAwB6B,UAAxB,CAAmCX,oBAAnC,EAAyDH,IAAzD,CAA8D,YAAM;AAClEtB,cAAAA,OAAO,CACLL,OAAO,CAACU,IAAR,CACE,KADF,8BAEwB0B,IAAI,CAACC,SAAL,CAAeP,oBAAf,CAFxB,eADK,CAAP;AAMD,aAPD,EAOGF,KAPH,CAOS,UAASc,GAAT,EAAc;AACrBpC,cAAAA,MAAM,CACJL,KAAK,CAACS,IAAN,CACE,IADF,mCAE4BE,cAF5B,oCAEqEwB,IAAI,CAACC,SAAL,CAAeP,oBAAf,CAFrE,gCADI,CAAN;AAMD,aAdD;AAeD,WAhBD,MAiBK;AACHxB,YAAAA,MAAM,CACJL,KAAK,CAACS,IAAN,CACE,KADF,mCAE4BE,cAF5B,oCAEqEwB,IAAI,CAACC,SAAL,CAAeP,oBAAf,CAFrE,gCADI,CAAN;AAMD;AACF,SA1BD;AA4BD,OA7BD;;AA+BA,UAAI,OAAOA,oBAAP,IAA+B,QAAnC,EAA6C;AAC3C,eAAO,KAAI,CAACC,wBAAL,EAAP;AACD,OAFD,MAGK;AACH,eAAO,KAAI,CAACY,mBAAL,EAAP;AACD;AACF,KArFD;;AAuFA,QAAI,CAAC,KAAI,CAACE,UAAL,CAAgBzB,MAArB,EAA6B;AAC3B,UAAI0B,qBAAqB,GAAG/C,cAAc,CAACW,IAAf,CAAoB,KAApB,CAA5B;;AAEA,UAAIoC,qBAAqB,IAAI,IAA7B,EAAmC;AACjC,eAAO,KAAI,CAACvC,cAAL,EAAP;AACD,OAFD,MAGK,IAAIuC,qBAAqB,IAAI,YAA7B,EAA2C;AAC9C,eAAO,KAAI,CAACnC,gBAAL,EAAP;AACD,OAFI,MAGA,IAAImC,qBAAqB,IAAI,KAA7B,EAAoC;AACvC,eAAO,KAAI,CAACjB,cAAL,EAAP;AACD;AACF,KAZD,MAaK;AACH3B,MAAAA,cAAc,CAACQ,IAAf,CAAoB,KAApB;AACD;AAEF,GA5KM,CAAP;AA8KD","sourcesContent":["import isSubset from '../../utils/isSubset'\nimport logger from \"../../utils/logger\"\nimport selectionLevel from '../../api-utils/selectionLevel'\nimport success from '../../api-utils/success'\nimport error from '../../api-utils/error'\nimport showUserErrors from '../../api-utils/showUserErrors'\n\nexport default function deleteIt() {\n\n  return new Promise((resolve, reject) => {\n\n    // delete database\n    this.deleteDatabase = () => {\n      let dbName = this.dbName\n\n      indexedDB.deleteDatabase(dbName)\n      resolve(\n        success.call(\n          this,\n          `Database \"${ dbName }\" deleted.`\n        )\n      )\n    }\n\n    // delete collection\n    this.deleteCollection = () => {\n      let dbName = this.dbName\n      let collectionName = this.collectionName\n\n      // we can only delete one collection at a time, which is why we need a queue\n\n      this.addToDeleteCollectionQueue = (collectionName) => {\n        this.deleteCollectionQueue.queue.push(collectionName)\n        this.runDeleteCollectionQueue()\n      }\n\n      this.runDeleteCollectionQueue = () => {\n        if (this.deleteCollectionQueue.running == false) {\n          this.deleteCollectionQueue.running = true\n          this.deleteNextCollectionFromQueue()\n        }\n      }\n\n      this.deleteNextCollectionFromQueue = () => {\n        if (this.deleteCollectionQueue.queue.length) {\n          let collectionToDelete = this.deleteCollectionQueue.queue[0]\n          this.deleteCollectionQueue.queue.shift()\n\n          this.lf[collectionToDelete].dropInstance({\n            name        : dbName,\n            storeName   : collectionToDelete\n          }).then(() => {\n            this.deleteNextCollectionFromQueue()\n            resolve(\n              success.call(\n                this,\n                `Collection \"${ collectionToDelete }\" deleted.`\n              )\n            )\n          }).catch(error => {\n            reject(\n              error.call(\n                this,\n                `Collection \"${ collectionToDelete }\" could not be deleted.`\n              )\n            )\n          })\n        }\n        else {\n          this.deleteCollectionQueue.running = false\n        }\n      }\n\n      this.addToDeleteCollectionQueue(collectionName)\n    }\n\n    // delete document\n    this.deleteDocument = () => {\n\n      let collectionName = this.collectionName\n      let docSelectionCriteria = this.docSelectionCriteria\n\n      // delete document by criteria\n      this.deleteDocumentByCriteria = () => {\n        let keysForDeletion = []\n        this.lf[collectionName].iterate((value, key) => {\n          if (isSubset(value, docSelectionCriteria)) {\n            keysForDeletion.push(key)\n          }\n        }).then(() => {\n          if (!keysForDeletion.length) {\n            reject(\n              error.call(\n                this,\n                `No Documents found in \"${ collectionName }\" Collection with criteria ${ JSON.stringify(docSelectionCriteria) }. No documents deleted.`\n              )\n            )\n          }\n          if (keysForDeletion.length > 1) {\n            logger.warn.call(this, `Multiple documents (${ keysForDeletion.length }) with ${ JSON.stringify(docSelectionCriteria) } found.`)\n          }\n        }).then(() => {\n          keysForDeletion.forEach((key, index) => {\n            this.lf[collectionName].removeItem(key).then(() => {\n              if (index === (keysForDeletion.length - 1)) {\n                resolve(\n                  success.call(\n                    this,\n                    `${ keysForDeletion.length } Document${ keysForDeletion.length > 1 ? 's' : '' } with ${ JSON.stringify(docSelectionCriteria) } deleted.`\n                  )\n                )\n              }\n            }).catch(err => {\n              reject(\n                error.call(\n                  this,\n                  `Could not delete ${ keysForDeletion.length } Documents in ${ collectionName } Collection.`\n                )\n              )\n            })\n          })\n        })\n      }\n\n      // delete document by key\n      this.deleteDocumentByKey = () => {\n        this.lf[collectionName].getItem(docSelectionCriteria).then(value => {\n          if (value) {\n            this.lf[collectionName].removeItem(docSelectionCriteria).then(() => {\n              resolve(\n                success.call(\n                  this,\n                  `Document with key ${ JSON.stringify(docSelectionCriteria) } deleted.`\n                )\n              )\n            }).catch(function(err) {\n              reject(\n                error.call(\n                  this,\n                  `No Document found in \"${ collectionName }\" Collection with key ${ JSON.stringify(docSelectionCriteria) }. No document was deleted.`\n                )\n              )\n            });\n          }\n          else {\n            reject(\n              error.call(\n                this,\n                `No Document found in \"${ collectionName }\" Collection with key ${ JSON.stringify(docSelectionCriteria) }. No document was deleted.`\n              )\n            )\n          }\n        });\n\n      }\n\n      if (typeof docSelectionCriteria == 'object') {\n        return this.deleteDocumentByCriteria()\n      }\n      else {\n        return this.deleteDocumentByKey()\n      }\n    }\n    \n    if (!this.userErrors.length) {\n      let currentSelectionLevel = selectionLevel.call(this)\n  \n      if (currentSelectionLevel == 'db') {\n        return this.deleteDatabase()\n      }\n      else if (currentSelectionLevel == 'collection') {\n        return this.deleteCollection()\n      }\n      else if (currentSelectionLevel == 'doc') {\n        return this.deleteDocument()\n      }\n    }\n    else {\n      showUserErrors.call(this)\n    }\n\n  })\n\n}"]},"metadata":{},"sourceType":"module"}