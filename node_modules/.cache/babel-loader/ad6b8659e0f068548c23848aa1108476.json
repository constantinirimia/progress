{"ast":null,"code":"import isSubset from '../../utils/isSubset';\nimport logger from \"../../utils/logger\";\nimport selectionLevel from '../../api-utils/selectionLevel';\nimport success from '../../api-utils/success';\nimport error from '../../api-utils/error';\nimport showUserErrors from '../../api-utils/showUserErrors';\nexport default function deleteIt() {\n  var _this = this;\n\n  return new Promise(function (resolve, reject) {\n    // delete database\n    _this.deleteDatabase = function () {\n      var dbName = _this.dbName;\n      indexedDB.deleteDatabase(dbName);\n      resolve(success.call(_this, \"Database \\\"\".concat(dbName, \"\\\" deleted.\"), {\n        database: dbName\n      }));\n    }; // delete collection\n\n\n    _this.deleteCollection = function () {\n      var dbName = _this.dbName;\n      var collectionName = _this.collectionName; // we can only delete one collection at a time, which is why we need a queue\n\n      _this.addToDeleteCollectionQueue = function (collectionName) {\n        _this.deleteCollectionQueue.queue.push(collectionName);\n\n        _this.runDeleteCollectionQueue();\n      };\n\n      _this.runDeleteCollectionQueue = function () {\n        if (_this.deleteCollectionQueue.running == false) {\n          _this.deleteCollectionQueue.running = true;\n\n          _this.deleteNextCollectionFromQueue();\n        }\n      };\n\n      _this.deleteNextCollectionFromQueue = function () {\n        if (_this.deleteCollectionQueue.queue.length) {\n          var collectionToDelete = _this.deleteCollectionQueue.queue[0];\n\n          _this.deleteCollectionQueue.queue.shift();\n\n          _this.lf[collectionToDelete].dropInstance({\n            name: dbName,\n            storeName: collectionToDelete\n          }).then(function () {\n            _this.deleteNextCollectionFromQueue();\n\n            resolve(success.call(_this, \"Collection \\\"\".concat(collectionToDelete, \"\\\" deleted.\"), {\n              collection: collectionToDelete\n            }));\n          }).catch(function (error) {\n            reject(error.call(_this, \"Collection \\\"\".concat(collectionToDelete, \"\\\" could not be deleted.\")));\n          });\n        } else {\n          _this.deleteCollectionQueue.running = false;\n        }\n      };\n\n      _this.addToDeleteCollectionQueue(collectionName);\n    }; // delete document\n\n\n    _this.deleteDocument = function () {\n      var collectionName = _this.collectionName;\n      var docSelectionCriteria = _this.docSelectionCriteria; // delete document by criteria\n\n      _this.deleteDocumentByCriteria = function () {\n        var keysForDeletion = [];\n\n        _this.lf[collectionName].iterate(function (value, key) {\n          if (isSubset(value, docSelectionCriteria)) {\n            keysForDeletion.push(key);\n          }\n        }).then(function () {\n          if (!keysForDeletion.length) {\n            reject(error.call(_this, \"No Documents found in \\\"\".concat(collectionName, \"\\\" Collection with criteria \").concat(JSON.stringify(docSelectionCriteria), \". No documents deleted.\")));\n          }\n\n          if (keysForDeletion.length > 1) {\n            logger.warn.call(_this, \"Multiple documents (\".concat(keysForDeletion.length, \") with \").concat(JSON.stringify(docSelectionCriteria), \" found.\"));\n          }\n        }).then(function () {\n          keysForDeletion.forEach(function (key, index) {\n            _this.lf[collectionName].removeItem(key).then(function () {\n              if (index === keysForDeletion.length - 1) {\n                resolve(success.call(_this, \"\".concat(keysForDeletion.length, \" Document\").concat(keysForDeletion.length > 1 ? 's' : '', \" with \").concat(JSON.stringify(docSelectionCriteria), \" deleted.\"), {\n                  keys: keysForDeletion\n                }));\n              }\n            }).catch(function (err) {\n              reject(error.call(_this, \"Could not delete \".concat(keysForDeletion.length, \" Documents in \").concat(collectionName, \" Collection.\")));\n            });\n          });\n        });\n      }; // delete document by key\n\n\n      _this.deleteDocumentByKey = function () {\n        _this.lf[collectionName].getItem(docSelectionCriteria).then(function (value) {\n          if (value) {\n            _this.lf[collectionName].removeItem(docSelectionCriteria).then(function () {\n              resolve(success.call(_this, \"Document with key \".concat(JSON.stringify(docSelectionCriteria), \" deleted.\"), {\n                key: docSelectionCriteria\n              }));\n            }).catch(function (err) {\n              reject(error.call(this, \"No Document found in \\\"\".concat(collectionName, \"\\\" Collection with key \").concat(JSON.stringify(docSelectionCriteria), \". No document was deleted.\")));\n            });\n          } else {\n            reject(error.call(_this, \"No Document found in \\\"\".concat(collectionName, \"\\\" Collection with key \").concat(JSON.stringify(docSelectionCriteria), \". No document was deleted.\")));\n          }\n        });\n      };\n\n      if (typeof docSelectionCriteria == 'object') {\n        return _this.deleteDocumentByCriteria();\n      } else {\n        return _this.deleteDocumentByKey();\n      }\n    };\n\n    if (!_this.userErrors.length) {\n      var currentSelectionLevel = selectionLevel.call(_this);\n\n      if (currentSelectionLevel == 'db') {\n        return _this.deleteDatabase();\n      } else if (currentSelectionLevel == 'collection') {\n        return _this.deleteCollection();\n      } else if (currentSelectionLevel == 'doc') {\n        return _this.deleteDocument();\n      }\n    } else {\n      showUserErrors.call(_this);\n    }\n  });\n}","map":{"version":3,"sources":["/Users/constantine/Dev/FrontEnd/progress/node_modules/localbase/localbase/api/actions/delete.js"],"names":["isSubset","logger","selectionLevel","success","error","showUserErrors","deleteIt","Promise","resolve","reject","deleteDatabase","dbName","indexedDB","call","database","deleteCollection","collectionName","addToDeleteCollectionQueue","deleteCollectionQueue","queue","push","runDeleteCollectionQueue","running","deleteNextCollectionFromQueue","length","collectionToDelete","shift","lf","dropInstance","name","storeName","then","collection","catch","deleteDocument","docSelectionCriteria","deleteDocumentByCriteria","keysForDeletion","iterate","value","key","JSON","stringify","warn","forEach","index","removeItem","keys","err","deleteDocumentByKey","getItem","userErrors","currentSelectionLevel"],"mappings":"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","sourcesContent":["import isSubset from '../../utils/isSubset'\nimport logger from \"../../utils/logger\"\nimport selectionLevel from '../../api-utils/selectionLevel'\nimport success from '../../api-utils/success'\nimport error from '../../api-utils/error'\nimport showUserErrors from '../../api-utils/showUserErrors'\n\nexport default function deleteIt() {\n\n  return new Promise((resolve, reject) => {\n\n    // delete database\n    this.deleteDatabase = () => {\n      let dbName = this.dbName\n\n      indexedDB.deleteDatabase(dbName)\n      resolve(\n        success.call(\n          this,\n          `Database \"${ dbName }\" deleted.`,\n          { database: dbName }\n        )\n      )\n    }\n\n    // delete collection\n    this.deleteCollection = () => {\n      let dbName = this.dbName\n      let collectionName = this.collectionName\n\n      // we can only delete one collection at a time, which is why we need a queue\n\n      this.addToDeleteCollectionQueue = (collectionName) => {\n        this.deleteCollectionQueue.queue.push(collectionName)\n        this.runDeleteCollectionQueue()\n      }\n\n      this.runDeleteCollectionQueue = () => {\n        if (this.deleteCollectionQueue.running == false) {\n          this.deleteCollectionQueue.running = true\n          this.deleteNextCollectionFromQueue()\n        }\n      }\n\n      this.deleteNextCollectionFromQueue = () => {\n        if (this.deleteCollectionQueue.queue.length) {\n          let collectionToDelete = this.deleteCollectionQueue.queue[0]\n          this.deleteCollectionQueue.queue.shift()\n\n          this.lf[collectionToDelete].dropInstance({\n            name        : dbName,\n            storeName   : collectionToDelete\n          }).then(() => {\n            this.deleteNextCollectionFromQueue()\n            resolve(\n              success.call(\n                this,\n                `Collection \"${ collectionToDelete }\" deleted.`,\n                { collection: collectionToDelete }\n              )\n            )\n          }).catch(error => {\n            reject(\n              error.call(\n                this,\n                `Collection \"${ collectionToDelete }\" could not be deleted.`\n              )\n            )\n          })\n        }\n        else {\n          this.deleteCollectionQueue.running = false\n        }\n      }\n\n      this.addToDeleteCollectionQueue(collectionName)\n    }\n\n    // delete document\n    this.deleteDocument = () => {\n\n      let collectionName = this.collectionName\n      let docSelectionCriteria = this.docSelectionCriteria\n\n      // delete document by criteria\n      this.deleteDocumentByCriteria = () => {\n        let keysForDeletion = []\n        this.lf[collectionName].iterate((value, key) => {\n          if (isSubset(value, docSelectionCriteria)) {\n            keysForDeletion.push(key)\n          }\n        }).then(() => {\n          if (!keysForDeletion.length) {\n            reject(\n              error.call(\n                this,\n                `No Documents found in \"${ collectionName }\" Collection with criteria ${ JSON.stringify(docSelectionCriteria) }. No documents deleted.`\n              )\n            )\n          }\n          if (keysForDeletion.length > 1) {\n            logger.warn.call(this, `Multiple documents (${ keysForDeletion.length }) with ${ JSON.stringify(docSelectionCriteria) } found.`)\n          }\n        }).then(() => {\n          keysForDeletion.forEach((key, index) => {\n            this.lf[collectionName].removeItem(key).then(() => {\n              if (index === (keysForDeletion.length - 1)) {\n                resolve(\n                  success.call(\n                    this,\n                    `${ keysForDeletion.length } Document${ keysForDeletion.length > 1 ? 's' : '' } with ${ JSON.stringify(docSelectionCriteria) } deleted.`,\n                    { keys: keysForDeletion }\n                  )\n                )\n              }\n            }).catch(err => {\n              reject(\n                error.call(\n                  this,\n                  `Could not delete ${ keysForDeletion.length } Documents in ${ collectionName } Collection.`\n                )\n              )\n            })\n          })\n        })\n      }\n\n      // delete document by key\n      this.deleteDocumentByKey = () => {\n        this.lf[collectionName].getItem(docSelectionCriteria).then(value => {\n          if (value) {\n            this.lf[collectionName].removeItem(docSelectionCriteria).then(() => {\n              resolve(\n                success.call(\n                  this,\n                  `Document with key ${ JSON.stringify(docSelectionCriteria) } deleted.`,\n                  { key: docSelectionCriteria }\n                )\n              )\n            }).catch(function(err) {\n              reject(\n                error.call(\n                  this,\n                  `No Document found in \"${ collectionName }\" Collection with key ${ JSON.stringify(docSelectionCriteria) }. No document was deleted.`\n                )\n              )\n            });\n          }\n          else {\n            reject(\n              error.call(\n                this,\n                `No Document found in \"${ collectionName }\" Collection with key ${ JSON.stringify(docSelectionCriteria) }. No document was deleted.`\n              )\n            )\n          }\n        });\n\n      }\n\n      if (typeof docSelectionCriteria == 'object') {\n        return this.deleteDocumentByCriteria()\n      }\n      else {\n        return this.deleteDocumentByKey()\n      }\n    }\n    \n    if (!this.userErrors.length) {\n      let currentSelectionLevel = selectionLevel.call(this)\n  \n      if (currentSelectionLevel == 'db') {\n        return this.deleteDatabase()\n      }\n      else if (currentSelectionLevel == 'collection') {\n        return this.deleteCollection()\n      }\n      else if (currentSelectionLevel == 'doc') {\n        return this.deleteDocument()\n      }\n    }\n    else {\n      showUserErrors.call(this)\n    }\n\n  })\n\n}"]},"metadata":{},"sourceType":"module"}